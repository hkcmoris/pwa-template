# Apache configuration for PWA Template
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/css text/xml
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript application/json
    # Donâ€™t recompress already-compressed formats
    # AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# Optional if the host has Brotli:
<IfModule mod_brotli.c>
    BrotliCompressionQuality 5
    AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/css text/xml
    AddOutputFilterByType BROTLI_COMPRESS application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
</IfModule>

<IfModule mod_rewrite.c>
    Options -MultiViews
    RewriteEngine On
    
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Directly serve existing files or directories
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Fallback to index.php for application routing
    RewriteRule ^ index.php [QSA,L]
</IfModule>

<IfModule mod_headers.c>
    # Long-term caching for hashed static assets
    <FilesMatch "\.(css|js|mjs|png|jpg|jpeg|gif|svg|webp|avif|ico)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Micro-cache only anonymous HTML fragments; authenticated, API, or htmx
    # requests must bypass cache so gallery updates reflect immediately.
    <FilesMatch "\.(html|php)$">
        Header set Cache-Control "no-store, private" "expr=%{REQUEST_METHOD} != 'GET' || %{REQUEST_URI} =~ m#^/api/# || %{HTTP_COOKIE} =~ /(^|;\\s*)(token|refresh_token)=/ || %{HTTP_AUTHORIZATION} != '' || %{HTTP_HX_REQUEST} == 'true'"
        Header set Cache-Control "s-maxage=5, stale-while-revalidate=60" "expr=%{REQUEST_METHOD} == 'GET' && %{REQUEST_URI} !~ m#^/api/# && %{HTTP_COOKIE} !~ /(^|;\\s*)(token|refresh_token)=/ && %{HTTP_AUTHORIZATION} == '' && %{HTTP_HX_REQUEST} != 'true'"
    </FilesMatch>
</IfModule>
