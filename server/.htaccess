# Block .env (and variants like .env.local)
<FilesMatch "^\.env(\..*)?$">
    Require all denied
</FilesMatch>

# Apache configuration for PWA Template
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/css text/xml
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript application/json
    # Donâ€™t recompress already-compressed formats
    # AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# Optional if the host has Brotli:
<IfModule mod_brotli.c>
    BrotliCompressionQuality 5
    AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/css text/xml
    AddOutputFilterByType BROTLI_COMPRESS application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
</IfModule>

<IfModule mod_rewrite.c>
    # Options -MultiViews was commented out, because it caused errors on the production server
    # Options -MultiViews
    RewriteEngine On
    
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    RewriteRule ^sw(?:-[A-Za-z0-9]+)?\.js$ sw.php [QSA,L]

    # Directly serve existing files or directories
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Fallback to index.php for application routing
    RewriteRule ^ index.php [QSA,L]
</IfModule>

<IfModule mod_headers.c>
    # Long-term caching for hashed static assets
    <FilesMatch "\.(css|js|mjs|png|jpg|jpeg|gif|svg|webp|avif|ico)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Micro-cache HTML/PHP responses for 5s with stale-while-revalidate
    <FilesMatch "\.(html|php)$">
        Header set Cache-Control "s-maxage=5, stale-while-revalidate=60"
    </FilesMatch>
</IfModule>
