# Block .env (and variants like .env.local)
<FilesMatch "^\.env(\..*)?$">
    Require all denied
</FilesMatch>

# Apache configuration for PWA Template
AddType application/manifest+json .webmanifest

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/css text/xml
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript application/x-javascript application/json
    # Donâ€™t recompress already-compressed formats
    # AddOutputFilterByType DEFLATE font/woff2
</IfModule>

# Optional if the host has Brotli:
<IfModule mod_brotli.c>
    BrotliCompressionQuality 5
    AddOutputFilterByType BROTLI_COMPRESS text/plain text/html text/css text/xml
    AddOutputFilterByType BROTLI_COMPRESS application/xml application/xhtml+xml application/rss+xml
    AddOutputFilterByType BROTLI_COMPRESS application/javascript application/json
</IfModule>

<IfModule mod_rewrite.c>
    # Options -MultiViews was commented out, because it caused errors on the production server
    # Options -MultiViews
    RewriteEngine On
    
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # Service worker files (loader + hashed runtime)
    RewriteRule ^sw\.js$ sw.php [QSA,L]
    RewriteRule ^sw-[A-Za-z0-9_-]+\.js$ sw.php [QSA,L]
    RewriteRule ^sw/sw-[A-Za-z0-9_-]+\.js$ sw.php [QSA,L]

    # Directly serve existing files or directories
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Fallback to index.php for application routing
    RewriteRule ^ index.php [QSA,L]
</IfModule>

<IfModule mod_setenvif.c>
    # Disable micro-cache for editor/admin routes so updates reflect immediately
    SetEnvIf Request_URI "(^|/)editor(/|$)" MICROCACHE_BYPASS=1
    SetEnvIf Request_URI "(^|/)api(/|$)" MICROCACHE_BYPASS=1
    SetEnvIf Cookie "(^|;\s*)token=" MICROCACHE_BYPASS=1
    SetEnvIf Cookie "(^|;\s*)refresh_token=" MICROCACHE_BYPASS=1
</IfModule>


<IfModule mod_headers.c>
    # Long-term caching for hashed static assets
    <FilesMatch "\.(css|js|mjs|png|jpg|jpeg|gif|svg|webp|avif|ico|webmanifest)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Micro-cache HTML/PHP responses for 5s with stale-while-revalidate on public pages
    <FilesMatch "\.(html|php)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate" env=MICROCACHE_BYPASS
        Header set Pragma "no-cache" env=MICROCACHE_BYPASS
        Header setifempty Cache-Control "s-maxage=5, stale-while-revalidate=60" env=!MICROCACHE_BYPASS
    </FilesMatch>
</IfModule>
